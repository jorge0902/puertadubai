{
    "name": "registro-isabel",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "registro-isabel",
                "options": {}
            },
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                -240,
                -48
            ],
            "id": "460f1e98-2870-4ceb-9a94-53162733b4f0",
            "webhookId": "a3832d6a-3b62-4feb-aa88-bbccdbed69a9"
        },
        {
            "parameters": {
                "jsCode": "const fields = items[0].json.data?.fields || [];\n\nconst getVal = (text) => {\n  if (!fields.length) return undefined;\n  const found = fields.find(f => f.label && f.label.toLowerCase().includes(text.toLowerCase()));\n  return found ? found.value : undefined;\n};\n\n// Fallback for direct JSON body (React Form or Tally)\nconst getBodyVal = (key) => items[0].json[key] || items[0].json.body?.[key];\n\nreturn {\n  json: {\n    body: {\n      proximidad_viaje: getBodyVal('proximidad_viaje') || getVal('cerca estÃ¡s hoy'),\n      pasaporte_ok: getBodyVal('pasaporte_ok') || getVal('pasaporte vigente'),\n      presupuesto_rango: getBodyVal('presupuesto_rango') || getVal('presupuesto inicial'),\n      meta_viaje: getBodyVal('meta_viaje') || getVal('meta principal'),\n      Nombre: getBodyVal('nombre') || getBodyVal('Nombre') || getBodyVal('name') || getVal('nombre completo'),\n      Email: getBodyVal('email') || getBodyVal('Email') || getVal('correo electrÃ³nico'),\n      WhatsApp: getBodyVal('whatsapp') || getBodyVal('WhatsApp') || getVal('WhatsApp'),\n      interes_contacto: getBodyVal('interes_contacto') || getVal('contacte personalmente')\n    }\n  }\n};"
            },
            "name": "Tally Adapter",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                -80,
                -48
            ],
            "id": "tally-adapter-node"
        },
        {
            "parameters": {
                "conditions": {
                    "string": [
                        {
                            "value1": "={{ $json.body.Nombre }}",
                            "operation": "isNotEmpty"
                        },
                        {
                            "value1": "={{ $json.body.WhatsApp }}",
                            "operation": "isNotEmpty"
                        },
                        {
                            "value1": "={{ $json.body.Email }}",
                            "operation": "isNotEmpty"
                        }
                    ]
                }
            },
            "name": "Validar Inputs",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [
                120,
                -48
            ],
            "id": "validation-node-blindaje"
        },
        {
            "parameters": {
                "tableId": "leads_isabel",
                "fieldsUi": {
                    "fieldValues": [
                        {
                            "fieldId": "nombre",
                            "fieldValue": "={{ ($json.body.Nombre || '').toString().toLowerCase().replace(/\\b\\w/g, l => l.toUpperCase()) }}"
                        },
                        {
                            "fieldId": "whatsapp",
                            "fieldValue": "={{ $json.body.WhatsApp }}"
                        },
                        {
                            "fieldId": "email",
                            "fieldValue": "={{ $json.body.Email }}"
                        },
                        {
                            "fieldId": "proximidad_viaje",
                            "fieldValue": "={{ $json.body.proximidad_viaje }}"
                        },
                        {
                            "fieldId": "pasaporte_ok",
                            "fieldValue": "={{ $json.body.pasaporte_ok }}"
                        },
                        {
                            "fieldId": "presupuesto_rango",
                            "fieldValue": "={{ $json.body.presupuesto_rango }}"
                        },
                        {
                            "fieldId": "meta_viaje",
                            "fieldValue": "={{ $json.body.meta_viaje }}"
                        },
                        {
                            "fieldId": "interes_contacto",
                            "fieldValue": "={{ $json.body.interes_contacto }}"
                        },
                        {
                            "fieldId": "es_vip",
                            "fieldValue": "={{ (($json.body.presupuesto_rango || '').toString().includes('4,000') || ($json.body.presupuesto_rango || '').toString().includes('OpciÃ³n C')) ? true : false }}"
                        }
                    ]
                }
            },
            "name": "Supabase",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                320,
                -48
            ],
            "id": "24c57921-b7cf-4ba8-ae55-9fecdf54a673",
            "credentials": {
                "supabaseApi": {
                    "id": "adwOlpOVzQbJ5lla",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{ $json.es_vip }}",
                            "value2": true
                        }
                    ]
                }
            },
            "name": "Check VIP",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [
                550,
                150
            ],
            "id": "check-vip-node"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "http://62.84.189.155:8080/message/sendText/puertadubai",
                "authentication": "none",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "apikey",
                            "value": "m8mhao5g7e99yrlz4s0dp6"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"number\": \"5358249692\",\n  \"textMessage\": {\n    \"text\": \"ğŸš¨ *ALERTA VIP* ğŸš¨\\n\\nÂ¡Isabel! Nuevo lead BALLENA detectado (+$4,000 USD). ğŸ‹\\n\\nğŸ‘¤ *Nombre:* {{ $json.nombre }}\\nğŸ“± *WhatsApp:* {{ $json.whatsapp }}\\nğŸ’° *Presupuesto:* {{ $json.presupuesto_rango }}\\nğŸ¯ *Meta:* {{ $json.meta_viaje }}\\n\\nÂ¡Revisa Supabase!\"\n  }\n}",
                "options": {}
            },
            "name": "Alert Isabel Whatsapp",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                780,
                150
            ],
            "id": "alert-isabel-node"
        },
        {
            "name": "Evolution API Final",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                550,
                -180
            ],
            "id": "258a7445-8f3c-4ea8-99b2-684dba24de02",
            "retryOnFail": false,
            "onError": "continueErrorOutput",
            "parameters": {
                "method": "POST",
                "url": "http://62.84.189.155:8080/message/sendText/puertadubai",
                "authentication": "none",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "apikey",
                            "value": "m8mhao5g7e99yrlz4s0dp6"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"number\": \"{{ ($json.whatsapp || $json.body.WhatsApp || $node['Webhook'].json.body.WhatsApp).toString().replace(/\\D/g, '') }}\",\n  \"textMessage\": {\n    \"text\": \"Â¡Hola, {{ ($json.nombre || $json.body.Nombre || $node['Webhook'].json.body.Nombre).toString().toLowerCase().replace(/\\b\\w/g, l => l.toUpperCase()) }}! âœ¨ QuÃ© gusto saludarte.\\n\\nSoy Isabel, de Dhahabi Agency. MuchÃ­simas gracias por registrarte y por tu interÃ©s en lo que estamos construyendo en DubÃ¡i. ğŸ‡¦ğŸ‡ª\\n\\nAcabo de enviarte un regalo de bienvenida a tu correo electrÃ³nico: nuestro catÃ¡logo exclusivo con todo lo que necesitas saber para empezar en los Emiratos. ğŸ“©\\n\\nDos cositas rÃ¡pidas: 1ï¸âƒ£ Corre a revisar tu bandeja de entrada (si no lo ves, chequea en Spam, Â¡a veces Google se pone caprichoso! ğŸ˜…). 2ï¸âƒ£ Guarda mi nÃºmero en tus contactos para que siempre estemos conectados por aquÃ­.\\n\\nCualquier duda que tengas, solo escrÃ­beme. Â¡Estoy lista para ayudarte! ğŸš€\"\n  }\n}",
                "options": {}
            }
        },
        {
            "parameters": {
                "fromEmail": "puertadubbai@gmail.com",
                "toEmail": "={{ $json.email || $node['Webhook'].json.body.Email }}",
                "subject": "Â¡Bienvenido a DubÃ¡i! ğŸ‡¦ğŸ‡ª Tu viaje empieza hoy âœ¨",
                "emailFormat": "html",
                "html": "=<div style=\"font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 600px; margin: 0 auto; background-color: #ffffff; color: #333;\">\n    <!-- Banner -->\n    <img src=\"http://62.84.189.155/imagenes/imagen1.jpg\" alt=\"Puerta DubÃ¡i\" style=\"width: 100%; max-width: 100%; height: auto; display: block;\">\n    \n    <div style=\"padding: 30px;\">\n        <p style=\"font-size: 16px; line-height: 1.6;\">Â¡Hola <strong>{{ ($json.nombre || $node['Webhook'].json.body.Nombre || 'Futuro Residente').toString().toLowerCase().replace(/\\b\\w/g, l => l.toUpperCase()) }}</strong>! âœ¨</p>\n        \n        <p style=\"font-size: 16px; line-height: 1.6;\">No sabes la alegrÃ­a que me da saludarte. Si estÃ¡s leyendo esto, es porque algo dentro de ti ya empezÃ³ a viajar hacia los Emiratos. ğŸ‡¦ğŸ‡ªâœˆï¸</p>\n        \n        <p style=\"font-size: 16px; line-height: 1.6;\">SÃ© que dar el paso impone respeto â€”yo tambiÃ©n estuve ahÃ­â€”, pero quiero que sepas algo muy importante: <strong>no vas a hacerlo solo.</strong></p>\n        \n        <p style=\"font-size: 16px; line-height: 1.6;\">Estoy aquÃ­ para ser esa amiga experta que te guÃ­a, te cuida y te ahorra los dolores de cabeza que yo pasÃ©. Mi misiÃ³n en <em>Dhahabi Agency</em> no es venderte un trÃ¡mite, es asegurarme de que tu llegada sea un Ã©xito.</p>\n        \n        <div style=\"text-align: center; margin: 30px 0;\">\n            <a href=\"https://soytu.puertadubai.online/catalogo.pdf\" style=\"background-color: #D4AF37; color: #ffffff; padding: 15px 30px; text-decoration: none; font-weight: bold; font-size: 16px; border-radius: 5px; display: inline-block; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 6px rgba(212, 175, 55, 0.3);\">Descargar CatÃ¡logo ğŸ“©</a>\n        </div>\n        \n        <p style=\"font-size: 16px; line-height: 1.6;\">Ã‰chale un vistazo con calma, visualÃ­zate allÃ­... y cuando estÃ©s listo, hablamos.</p>\n        \n        <p style=\"font-size: 16px; line-height: 1.6; margin-top: 40px;\">Con cariÃ±o,</p>\n        \n        <div style=\"margin-top: 10px;\">\n            <strong style=\"font-size: 18px;\">Isabel</strong><br>\n            <span style=\"color: #666;\">CEO, Dhahabi Agency</span>\n        </div>\n        \n        <!-- Footer -->\n        <div style=\"margin-top: 50px; padding-top: 30px; border-top: 1px solid #eeeeee; text-align: center;\">\n            <!-- Logo Puerta DubÃ¡i -->\n            <img src=\"http://62.84.189.155/imagenes/logo%20puertadubai.png\" alt=\"Puerta DubÃ¡i\" style=\"max-width: 80px; height: auto; display: inline-block; margin-bottom: 5px;\">\n            \n            <p style=\"font-size: 10px; color: #bbb;\">Â© 2026 Dhahabi Agency</p>\n        </div>\n    </div>\n</div>",
                "options": {
                    "allowUnauthorizedCerts": true
                }
            },
            "name": "Gmail SMTP",
            "type": "n8n-nodes-base.emailSend",
            "typeVersion": 2,
            "position": [
                550,
                0
            ],
            "id": "e4f8d9c2-premium-email",
            "credentials": {
                "smtp": {
                    "id": "d9MsDiSEqUJr2oM4",
                    "name": "Dhahabi Legacy SMTP (Double B)"
                }
            }
        }
    ],
    "connections": {
        "Webhook": {
            "main": [
                [
                    {
                        "node": "Tally Adapter",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Tally Adapter": {
            "main": [
                [
                    {
                        "node": "Validar Inputs",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Validar Inputs": {
            "main": [
                [
                    {
                        "node": "Supabase",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Supabase": {
            "main": [
                [
                    {
                        "node": "Evolution API Final",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Gmail SMTP",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Check VIP",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check VIP": {
            "main": [
                [
                    {
                        "node": "Alert Isabel Whatsapp",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}